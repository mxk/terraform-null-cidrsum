run "example" {
  module { source = "./" }

  variables {
    cidrs = ["0.0.0.0/32", "0.0.0.1/32", "0.0.0.2/31"]
  }

  assert {
    condition     = output.cidrs == tolist(["0.0.0.0/30"])
    error_message = "Fail"
  }
}

run "dup" {
  module { source = "./" }

  variables {
    cidrs = ["10.0.0.1/8", "010.255.255.255/08"]
  }

  assert {
    condition     = output.cidrs == tolist(["10.0.0.0/8"])
    error_message = "Fail"
  }
}

run "complete" {
  module { source = "./" }

  variables {
    cidrs = [
      "0.0.0.0/32",
      "0.0.0.1/32",
      "0.0.0.2/31",
      "0.0.0.4/30",
      "0.0.0.8/29",
      "0.0.0.16/28",
      "0.0.0.32/27",
      "0.0.0.64/26",
      "0.0.0.128/25",
      "0.0.1.0/24",
      "0.0.2.0/23",
      "0.0.4.0/22",
      "0.0.8.0/21",
      "0.0.16.0/20",
      "0.0.32.0/19",
      "0.0.64.0/18",
      "0.0.128.0/17",
      "0.1.0.0/16",
      "0.2.0.0/15",
      "0.4.0.0/14",
      "0.8.0.0/13",
      "0.16.0.0/12",
      "0.32.0.0/11",
      "0.64.0.0/10",
      "0.128.0.0/9",
      "1.0.0.0/8",
      "2.0.0.0/7",
      "4.0.0.0/6",
      "8.0.0.0/5",
      "16.0.0.0/4",
      "32.0.0.0/3",
      "64.0.0.0/2",
      "128.0.0.0/1",
    ]
  }

  assert {
    condition     = output.cidrs == tolist(["0.0.0.0/0"])
    error_message = "Fail"
  }
}

run "zero" {
  module { source = "./" }

  variables {
    cidrs = ["255.255.255.255/32", "0.0.0.0/0"]
  }

  assert {
    condition     = output.cidrs == tolist(["0.0.0.0/0"])
    error_message = "Fail"
  }
}

# https://github.com/hashicorp/terraform/issues/24005#issuecomment-1377572353
run "netaddr" {
  module { source = "./" }

  variables {
    cidrs = [
      "16.12.24.0/21",
      "16.12.32.0/22",
      "3.5.134.0/23",
      "3.5.136.0/22",
      "3.65.246.0/28",
      "3.65.246.16/28",
      "52.219.140.0/24",
      "52.219.168.0/24",
      "52.219.169.0/24",
      "52.219.170.0/23",
      "52.219.208.0/23",
      "52.219.210.0/24",
      "52.219.211.0/24",
      "52.219.218.0/24",
      "52.219.44.0/22",
      "52.219.72.0/22",
    ]
  }

  assert {
    condition = output.cidrs == sort([
      "3.5.134.0/23",
      "3.5.136.0/22",
      "3.65.246.0/27",
      "16.12.24.0/21",
      "16.12.32.0/22",
      "52.219.44.0/22",
      "52.219.72.0/22",
      "52.219.140.0/24",
      "52.219.168.0/22",
      "52.219.208.0/22",
      "52.219.218.0/24",
    ])
    error_message = "Fail"
  }
}
